<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸµ æ­Œæ›²å¯¼å…¥ & æ­Œè¯æœç´¢</title>
<style>
:root{--main:#6366f1;--bg:#f7f9fc;--card:#fff;--line:#e5e7eb;--text:#111;--muted:#6b7280;}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);padding:30px;display:flex;justify-content:center;}
.wrap{width:100%;max-width:640px;background:var(--card);border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:28px;}
h1{font-size:22px;margin:0 0 18px;}
section{margin-bottom:32px;}
button{padding:10px 20px;border:none;border-radius:8px;background:var(--main);color:#fff;font-size:16px;cursor:pointer;}
button:disabled{opacity:.5;}
.status{margin-top:12px;color:var(--muted);}
input[type=text],input[type=file]{width:100%;padding:10px 12px;margin-bottom:14px;border:1px solid var(--line);border-radius:8px;font-size:15px;}
.result{max-height:60vh;overflow:auto;}
.item{padding:12px 0;border-bottom:1px solid var(--line);}
.item .title{font-size:15px;color:var(--muted);margin-bottom:4px;}
.item .lyrics{font-size:17px;color:var(--text);white-space:pre-wrap;line-height:1.5;}
.highlight{background:#fef08a;font-weight:600;}
.none{color:var(--muted);}
</style>
</head>
<body>
<div class="wrap">
  <!-- å¯¼å…¥åŒº -->
  <section>
    <h1>ğŸµ å¯¼å…¥æ­Œæ›²åˆ° Supabase</h1>
    <p>è¯·é€‰æ‹©åŒ…å«â€œæ­Œå / titleã€åŸå”± / artistã€å‘è¡Œå¹´ / yearã€æ­Œè¯ / lyricsâ€å››åˆ—çš„ Excel æ–‡ä»¶ï¼š</p>
    <input type="file" id="fileInput" accept=".xlsx,.xls" />
    <button id="uploadBtn">ä¸Šä¼ åˆ° Supabase</button>
    <div id="status" class="status"></div>
  </section>

  <!-- æœç´¢åŒº -->
  <section>
    <h1>ğŸ” æ­Œè¯æœç´¢</h1>
    <input id="searchInput" type="text" placeholder="è¾“å…¥æ­Œè¯å…³é”®è¯â€¦" />
    <div id="result" class="result">è¯·è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢ã€‚</div>
  </section>
</div>

<!-- ä¾èµ– -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
/* ========== Supabase é…ç½® ========== */
const SUPABASE_URL  = 'https://jstizcjnfujlffdkdnov.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpzdGl6Y2puZnVqbGZmZGtkbm92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MTIxNTMsImV4cCI6MjA3Nzk4ODE1M30.xTOGlMQXmOTqXApPXI1TK4XZ0fkFjzGnP0LZDMYFZ24';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ========== ä¸Šä¼  Excel ========== */
const fileInput = document.getElementById('fileInput');
const uploadBtn = document.getElementById('uploadBtn');
const statusDiv = document.getElementById('status');

uploadBtn.onclick = async () => {
  const file = fileInput.files[0];
  if (!file) return alert("è¯·å…ˆé€‰æ‹© Excel æ–‡ä»¶ï¼");
  uploadBtn.disabled = true;
  statusDiv.textContent = "æ­£åœ¨è§£æ Excel...";

  try {
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

    if (!rows.length) { statusDiv.textContent = "Excel å†…å®¹ä¸ºç©ºï¼"; uploadBtn.disabled = false; return; }

    const payload = rows.map(r => ({
      title: (r["title"] || r["æ­Œå"] || "").trim(),
      artist: (r["artist"] || r["åŸå”±"] || "").trim(),
      year:   parseInt(r["year"] || r["å‘è¡Œå¹´"]) || null,
      lyrics: (r["lyrics"] || r["æ­Œè¯"] || "").trim()
    })).filter(r => r.title && r.lyrics);

    statusDiv.textContent = `å…±è§£æå‡º ${payload.length} æ¡è®°å½•ï¼Œæ­£åœ¨ä¸Šä¼ ...`;

    const batch = 50;
    for (let i = 0; i < payload.length; i += batch) {
      const { error } = await sb.from("songs").insert(payload.slice(i, i + batch));
      if (error) throw error;
      statusDiv.textContent = `å·²ä¸Šä¼  ${Math.min(i + batch, payload.length)} / ${payload.length}`;
    }

    statusDiv.textContent = "âœ… ä¸Šä¼ å®Œæˆï¼";
  } catch (err) {
    statusDiv.textContent = "âŒ å¯¼å…¥å¤±è´¥ï¼š" + err.message;
  } finally {
    uploadBtn.disabled = false;
  }
};

/* ========== æœç´¢æ­Œè¯ ========== */
const searchInput = document.getElementById('searchInput');
const resultDiv = document.getElementById('result');

searchInput.addEventListener('input', e => {
  const kw = e.target.value.trim();
  if (kw.length === 0) {
    resultDiv.textContent = 'è¯·è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢ã€‚';
  } else {
    searchLyrics(kw);
  }
});

async function searchLyrics(kw) {
  resultDiv.textContent = 'æœç´¢ä¸­â€¦';
  const { data, error } = await sb.from('songs').select('title,artist,year,lyrics').ilike('lyrics', `%${kw}%`).limit(100);
  if (error) { resultDiv.textContent = 'âŒ æœç´¢å¤±è´¥ï¼š' + error.message; return; }
  renderResults(data, kw);
}

function renderResults(rows, kw) {
  if (!rows.length) return resultDiv.innerHTML = '<p class="none">æœªæ‰¾åˆ°ç›¸å…³æ­Œè¯ã€‚</p>';
  resultDiv.innerHTML = '';
  rows.forEach(r => {
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <div class="title">${esc(r.title)} â€” ${esc(r.artist || '')} (${esc(r.year || '')})</div>
      <div class="lyrics">${highlight(esc(r.lyrics || ''), kw)}</div>`;
    resultDiv.appendChild(div);
  });
}
function esc(str) { return str.replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
function highlight(txt, kw) {
  const re = new RegExp(kw, 'gi');
  return txt.replace(re, match => `<span class="highlight">${match}</span>`);
}
</script>
</body>
</html>
