<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æ­Œæ›²èµ„æ–™å¯¼å…¥å·¥å…·</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
  body{font-family:system-ui,Arial;background:#f8fafc;margin:0;padding:20px;}
  .wrap{max-width:700px;margin:0 auto;background:#fff;padding:24px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.08);}
  h1{font-size:22px;margin-bottom:12px;}
  input{padding:8px;font-size:15px;}
  button{padding:10px 18px;background:#007bff;color:#fff;border:none;border-radius:8px;cursor:pointer;margin-top:10px;}
  button:disabled{background:#ccc;}
  .status{margin-top:16px;font-size:14px;color:#555;}
  table{width:100%;border-collapse:collapse;margin-top:16px;}
  th,td{border:1px solid #eee;padding:8px;text-align:center;font-size:14px;}
  th{background:#f3f6fb;}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸµ Excel å¯¼å…¥æ­Œæ›²èµ„æ–™</h1>
  <p>è¡¨æ ¼éœ€åŒ…å«åˆ—ï¼š<b>æ­Œå</b>ã€<b>åŸå”±</b>ã€<b>å‘è¡Œå¹´</b>ã€<b>æ­Œè¯</b></p>
  <input type="file" id="fileInput" accept=".xlsx,.xls" />
  <button id="uploadBtn" disabled>ä¸Šä¼ åˆ° Supabase</button>
  <div class="status" id="status">æœªé€‰æ‹©æ–‡ä»¶ã€‚</div>

  <table id="previewTable" style="display:none;">
    <thead><tr><th>æ­Œå</th><th>åŸå”±</th><th>å‘è¡Œå¹´</th><th>æ­Œè¯</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script>
  // âœ… æ›¿æ¢ä¸ºä½ çš„ Supabase é¡¹ç›®ä¿¡æ¯
  const SUPABASE_URL = "https://jstizcjnfujlffdkdnov.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpzdGl6Y2puZnVqbGZmZGtkbm92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MTIxNTMsImV4cCI6MjA3Nzk4ODE1M30.xTOGlMQXmOTqXApPXI1TK4XZ0fkFjzGnP0LZDMYFZ24";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const statusEl = document.getElementById('status');
  const tableBody = document.querySelector('#previewTable tbody');
  const previewTable = document.getElementById('previewTable');

  let songsData = [];

  // è¯»å–Excelæ–‡ä»¶
  fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet);
      songsData = json.map(row => ({
        title: row["æ­Œå"] || "",
        artist: row["åŸå”±"] || "",
        year: row["å‘è¡Œå¹´"] || "",
        lyrics: row["æ­Œè¯"] || ""
      }));
      renderPreview(songsData);
      uploadBtn.disabled = songsData.length === 0;
      statusEl.textContent = `å·²è¯»å– ${songsData.length} æ¡è®°å½•ã€‚`;
    };
    reader.readAsArrayBuffer(file);
  });

  // ä¸Šä¼ åˆ° Supabase
  uploadBtn.addEventListener('click', async () => {
    if (songsData.length === 0) return alert("è¯·å…ˆé€‰æ‹©Excelæ–‡ä»¶ã€‚");
    uploadBtn.disabled = true;
    statusEl.textContent = "æ­£åœ¨ä¸Šä¼ ï¼Œè¯·ç¨å€™...";
    const { error } = await supabase.from("songs").insert(songsData);
    uploadBtn.disabled = false;
    if (error) {
      console.error(error);
      statusEl.textContent = "ä¸Šä¼ å¤±è´¥ï¼š" + error.message;
    } else {
      statusEl.textContent = "âœ… ä¸Šä¼ æˆåŠŸï¼Œå…± " + songsData.length + " æ¡è®°å½•ï¼";
    }
  });

  function renderPreview(rows) {
    previewTable.style.display = rows.length ? "table" : "none";
    tableBody.innerHTML = "";
    rows.slice(0, 10).forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r.title}</td><td>${r.artist}</td><td>${r.year}</td><td>${r.lyrics.slice(0,50)}...</td>`;
      tableBody.appendChild(tr);
    });
  }
</script>
</body>
</html>
