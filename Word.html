<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸµ æ­Œæ›²æ•°æ®å¯¼å…¥å™¨</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:#f7f9fc;padding:30px;}
.wrap{max-width:600px;margin:0 auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.08);}
h1{font-size:22px;margin-bottom:16px;}
input[type=file]{margin-top:10px;}
button{margin-top:15px;padding:10px 20px;border:none;border-radius:8px;background:#007bff;color:#fff;font-size:16px;cursor:pointer;}
button:disabled{opacity:.6;}
.status{margin-top:15px;color:#333;}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸµ å¯¼å…¥æ­Œæ›²åˆ° Supabase</h1>
  <p>è¯·é€‰æ‹©åŒ…å«â€œæ­Œåã€åŸå”±ã€å‘è¡Œå¹´ã€æ­Œè¯â€å››åˆ—çš„ Excel æ–‡ä»¶ï¼š</p>
  <input type="file" id="fileInput" accept=".xlsx,.xls" />
  <button id="uploadBtn">ä¸Šä¼ åˆ° Supabase</button>
  <div id="status" class="status"></div>
</div>

<!-- XLSX è§£æåº“ -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<script>
const SUPABASE_URL = "https://jstizcjnfujlffdkdnov.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpzdGl6Y2puZnVqbGZmZGtkbm92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MTIxNTMsImV4cCI6MjA3Nzk4ODE1M30.xTOGlMQXmOTqXApPXI1TK4XZ0fkFjzGnP0LZDMYFZ24";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const fileInput = document.getElementById("fileInput");
const uploadBtn = document.getElementById("uploadBtn");
const statusDiv = document.getElementById("status");

uploadBtn.onclick = async () => {
  const file = fileInput.files[0];
  if (!file) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ª Excel æ–‡ä»¶ï¼");
  
  uploadBtn.disabled = true;
  statusDiv.textContent = "æ­£åœ¨è§£æ Excel...";

  const reader = new FileReader();
  reader.onload = async (e) => {
    const workbook = XLSX.read(e.target.result, { type: "binary" });
    const sheetName = workbook.SheetNames[0];
    const data = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

    if (!data.length) return statusDiv.textContent = "Excel æ–‡ä»¶ä¸ºç©ºã€‚";

    // è½¬æ¢ä¸º Supabase å¯è¯†åˆ«å­—æ®µ
    const rows = data.map(r => ({
      title: r["æ­Œå"]?.toString().trim() || "æœªå‘½å",
      artist: r["åŸå”±"] || null,
      year: r["å‘è¡Œå¹´"] || null,
      lyrics: r["æ­Œè¯"] || null
    }));

    statusDiv.textContent = "æ­£åœ¨ä¸Šä¼ åˆ° Supabaseï¼ˆå…± " + rows.length + " æ¡ï¼‰...";

    // åˆ†æ‰¹ä¸Šä¼ é¿å…è¶…æ—¶
    const batchSize = 50;
    for (let i = 0; i < rows.length; i += batchSize) {
      const chunk = rows.slice(i, i + batchSize);
      const { error } = await supabase.from("songs").insert(chunk);
      if (error) {
        console.error(error);
        statusDiv.textContent = "âŒ å¯¼å…¥å¤±è´¥ï¼š" + error.message;
        uploadBtn.disabled = false;
        return;
      }
      statusDiv.textContent = `å·²ä¸Šä¼  ${Math.min(i+batchSize, rows.length)}/${rows.length}`;
    }

    statusDiv.textContent = "âœ… å…¨éƒ¨ä¸Šä¼ å®Œæˆï¼";
    uploadBtn.disabled = false;
  };
  reader.readAsBinaryString(file);
};
</script>
</body>
</html>
