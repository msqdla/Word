<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ­Œè¯æœç´¢å™¨ï¼ˆExcel å¯¼å…¥ç‰ˆï¼‰</title>
<style>
  :root{--main:#6366f1;--bg:#f8fafc;--card:#fff;--line:#e5e7eb;}
  body{margin:0;font-family:system-ui,Arial;background:var(--bg);display:flex;justify-content:center;padding:40px 20px;}
  .card{width:100%;max-width:640px;background:var(--card);border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:32px;}
  h1{margin:0 0 24px;font-size:24px;font-weight:600;color:#111;}
  input[type=text]{width:100%;padding:10px 14px;border:1px solid var(--line);border-radius:8px;font-size:16px;}
  .result{margin-top:24px;}
  .song{padding:12px 0;border-bottom:1px solid var(--line);}
  .lyrics{white-space:pre-wrap;color:#444;margin-top:6px;font-size:15px;line-height:1.5;}
  .highlight{background:#fef08a;font-weight:600;}
  .none{color:#9ca3af;margin-top:10px;}
  /* å¯¼å…¥åŒºåŸŸ */
  .upload-area{margin:24px 0 16px;display:flex;align-items:center;gap:12px;}
  input[type=file]{font-size:14px;}
  button{background:var(--main);color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;}
  button:disabled{opacity:.6;cursor:not-allowed;}
</style>
</head>
<body>
<div class="card">
  <h1>ğŸµ æ­Œè¯æœç´¢å™¨</h1>

  <!-- æœç´¢ -->
  <input id="searchInput" type="text" placeholder="è¾“å…¥æ­Œè¯å…³é”®è¯â€¦" />

  <!-- Excel ä¸Šä¼  -->
  <div class="upload-area">
    <input type="file" id="excelFile" accept=".xlsx,.xls" />
    <button id="uploadBtn">å¯¼å…¥æ­Œè¯</button>
  </div>

  <!-- ç»“æœ -->
  <div id="result" class="result">è¯·è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢ã€‚</div>
</div>

<!-- ä¾èµ– -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
  /* ======== 1. Supabase åˆå§‹åŒ– ======== */
  const SUPABASE_URL  = 'https://jstizcjnfujlffdkdnov.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpzdGl6Y2puZnVqbGZmZGtkbm92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MTIxNTMsImV4cCI6MjA3Nzk4ODE1M30.xTOGlMQXmOTqXApPXI1TK4XZ0fkFjzGnP0LZDMYFZ24';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  /* ======== 2. æœç´¢ï¼ˆä»… lyricsï¼‰ ======== */
  const input   = document.getElementById('searchInput');
  const result  = document.getElementById('result');

  async function searchLyrics(kw){
    if(!kw.trim()) return result.textContent='';
    result.textContent='æœç´¢ä¸­â€¦';
    const {data,error} = await sb
      .from('songs')
      .select('id,lyrics')
      .ilike('lyrics', `%${kw}%`)
      .limit(100);
    if(error) return result.textContent='æœç´¢å¤±è´¥ï¼š'+error.message;
    render(data,kw);
  }
  function render(rows,kw){
    if(!rows.length) return result.innerHTML='<p class="none">æœªæ‰¾åˆ°ç›¸å…³æ­Œè¯ã€‚</p>';
    result.innerHTML='';
    rows.forEach(r=>{
      const div=document.createElement('div');div.className='song';
      div.innerHTML=`<div class="lyrics">${highlight(r.lyrics,kw)}</div>`;
      result.appendChild(div);
    });
  }
  function highlight(txt,kw){
    return txt.replaceAll(kw,`<span class="highlight">${kw}</span>`);
  }
  input.addEventListener('input',e=>{
    const kw=e.target.value.trim();
    if(kw) searchLyrics(kw); else result.textContent='è¯·è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢ã€‚';
  });

  /* ======== 3. Excel å¯¼å…¥ ======== */
  const fileIn  = document.getElementById('excelFile');
  const uploadBtn=document.getElementById('uploadBtn');
  uploadBtn.onclick=async()=>{
    const f=fileIn.files[0];
    if(!f) return alert('è¯·å…ˆé€‰æ‹© Excel æ–‡ä»¶');
    uploadBtn.disabled=true;
    const wb=XLSX.read(await f.arrayBuffer(),{type:'array'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const data=XLSX.utils.sheet_to_json(ws,{header:1}); // äºŒç»´æ•°ç»„
    // çº¦å®šï¼šA åˆ—å°±æ˜¯æ­Œè¯ï¼Œå…¶å®ƒåˆ—å¿½ç•¥
    const lyrics=data.map(r=>r[0]).filter(v=>typeof v==='string'&&v.trim());
    if(!lyrics.length){alert('æœªè¯»å–åˆ°ä»»ä½•æ­Œè¯ï¼');uploadBtn.disabled=false;return;}
    const payload=lyrics.map(text=>({lyrics:text.trim()}));
    const {error}=await sb.from('songs').insert(payload);
    uploadBtn.disabled=false;
    if(error) alert('å¯¼å…¥å¤±è´¥ï¼š'+error.message);
    else alert(`æˆåŠŸå¯¼å…¥ ${payload.length} æ¡æ­Œè¯ï¼`);
  };
</script>
</body>
</html>
